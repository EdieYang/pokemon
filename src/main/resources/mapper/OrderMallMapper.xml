<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pokepet.dao.OrderMallMapper">
  <resultMap id="BaseResultMap" type="com.pokepet.model.OrderMall">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    <id column="order_id" jdbcType="VARCHAR" property="orderId" />
    <result column="commodity_id" jdbcType="VARCHAR" property="commodityId" />
    <result column="commodity_type" jdbcType="VARCHAR" property="commodityType" />
    <result column="user_id" jdbcType="VARCHAR" property="userId" />
    <result column="address_id" jdbcType="VARCHAR" property="addressId" />
    <result column="buy_type" jdbcType="VARCHAR" property="buyType" />
    <result column="money" jdbcType="INTEGER" property="money" />
    <result column="coin" jdbcType="INTEGER" property="coin" />
    <result column="pay_type" jdbcType="VARCHAR" property="payType" />
    <result column="pay_time" jdbcType="TIMESTAMP" property="payTime" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="effective_time" jdbcType="TIMESTAMP" property="effectiveTime" />
    <result column="order_status" jdbcType="VARCHAR" property="orderStatus" />
    <result column="order_type" jdbcType="VARCHAR" property="orderType" />
    <result column="del_flag" jdbcType="VARCHAR" property="delFlag" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    order_id, commodity_id, commodity_type, user_id, address_id, buy_type, money, coin, 
    pay_type, pay_time, create_time, effective_time, order_status, order_type, del_flag
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    select 
    <include refid="Base_Column_List" />
    from order_mall
    where order_id = #{orderId,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    delete from order_mall
    where order_id = #{orderId,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.pokepet.model.OrderMall">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    insert into order_mall (order_id, commodity_id, commodity_type, 
      user_id, address_id, buy_type, 
      money, coin, pay_type, 
      pay_time, create_time, effective_time, 
      order_status, order_type, del_flag
      )
    values (#{orderId,jdbcType=VARCHAR}, #{commodityId,jdbcType=VARCHAR}, #{commodityType,jdbcType=VARCHAR}, 
      #{userId,jdbcType=VARCHAR}, #{addressId,jdbcType=VARCHAR}, #{buyType,jdbcType=VARCHAR}, 
      #{money,jdbcType=INTEGER}, #{coin,jdbcType=INTEGER}, #{payType,jdbcType=VARCHAR}, 
      #{payTime,jdbcType=TIMESTAMP}, #{createTime,jdbcType=TIMESTAMP}, #{effectiveTime,jdbcType=TIMESTAMP}, 
      #{orderStatus,jdbcType=VARCHAR}, #{orderType,jdbcType=VARCHAR}, #{delFlag,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.pokepet.model.OrderMall">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    insert into order_mall
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="orderId != null">
        order_id,
      </if>
      <if test="commodityId != null">
        commodity_id,
      </if>
      <if test="commodityType != null">
        commodity_type,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="addressId != null">
        address_id,
      </if>
      <if test="buyType != null">
        buy_type,
      </if>
      <if test="money != null">
        money,
      </if>
      <if test="coin != null">
        coin,
      </if>
      <if test="payType != null">
        pay_type,
      </if>
      <if test="payTime != null">
        pay_time,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="effectiveTime != null">
        effective_time,
      </if>
      <if test="orderStatus != null">
        order_status,
      </if>
      <if test="orderType != null">
        order_type,
      </if>
      <if test="delFlag != null">
        del_flag,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="orderId != null">
        #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="commodityId != null">
        #{commodityId,jdbcType=VARCHAR},
      </if>
      <if test="commodityType != null">
        #{commodityType,jdbcType=VARCHAR},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=VARCHAR},
      </if>
      <if test="addressId != null">
        #{addressId,jdbcType=VARCHAR},
      </if>
      <if test="buyType != null">
        #{buyType,jdbcType=VARCHAR},
      </if>
      <if test="money != null">
        #{money,jdbcType=INTEGER},
      </if>
      <if test="coin != null">
        #{coin,jdbcType=INTEGER},
      </if>
      <if test="payType != null">
        #{payType,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null">
        #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="effectiveTime != null">
        #{effectiveTime,jdbcType=TIMESTAMP},
      </if>
      <if test="orderStatus != null">
        #{orderStatus,jdbcType=VARCHAR},
      </if>
      <if test="orderType != null">
        #{orderType,jdbcType=VARCHAR},
      </if>
      <if test="delFlag != null">
        #{delFlag,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.pokepet.model.OrderMall">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    update order_mall
    <set>
      <if test="commodityId != null">
        commodity_id = #{commodityId,jdbcType=VARCHAR},
      </if>
      <if test="commodityType != null">
        commodity_type = #{commodityType,jdbcType=VARCHAR},
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=VARCHAR},
      </if>
      <if test="addressId != null">
        address_id = #{addressId,jdbcType=VARCHAR},
      </if>
      <if test="buyType != null">
        buy_type = #{buyType,jdbcType=VARCHAR},
      </if>
      <if test="money != null">
        money = #{money,jdbcType=INTEGER},
      </if>
      <if test="coin != null">
        coin = #{coin,jdbcType=INTEGER},
      </if>
      <if test="payType != null">
        pay_type = #{payType,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null">
        pay_time = #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="effectiveTime != null">
        effective_time = #{effectiveTime,jdbcType=TIMESTAMP},
      </if>
      <if test="orderStatus != null">
        order_status = #{orderStatus,jdbcType=VARCHAR},
      </if>
      <if test="orderType != null">
        order_type = #{orderType,jdbcType=VARCHAR},
      </if>
      <if test="delFlag != null">
        del_flag = #{delFlag,jdbcType=VARCHAR},
      </if>
    </set>
    where order_id = #{orderId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.pokepet.model.OrderMall">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 11 14:15:57 GMT+08:00 2018.
    -->
    update order_mall
    set commodity_id = #{commodityId,jdbcType=VARCHAR},
      commodity_type = #{commodityType,jdbcType=VARCHAR},
      user_id = #{userId,jdbcType=VARCHAR},
      address_id = #{addressId,jdbcType=VARCHAR},
      buy_type = #{buyType,jdbcType=VARCHAR},
      money = #{money,jdbcType=INTEGER},
      coin = #{coin,jdbcType=INTEGER},
      pay_type = #{payType,jdbcType=VARCHAR},
      pay_time = #{payTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      effective_time = #{effectiveTime,jdbcType=TIMESTAMP},
      order_status = #{orderStatus,jdbcType=VARCHAR},
      order_type = #{orderType,jdbcType=VARCHAR},
      del_flag = #{delFlag,jdbcType=VARCHAR}
    where order_id = #{orderId,jdbcType=VARCHAR}
  </update>
  
  <select id="selectCommodityList" parameterType="java.lang.String" resultType="java.util.Map">
  	SELECT 
	  t_o.order_id AS orderId,
	  t_u.nick_name AS nickName,
	  DATE_FORMAT(t_o.create_time,'%Y-%m-%d %H:%i:%s') AS orderTime,
	  t_o.price/100 AS price,
	  CASE t_o.order_status
	  WHEN '0' THEN '未支付'
	  WHEN '1' THEN '已支付'
	  ELSE '' END AS orderStatus,
	  IFNULL(DATE_FORMAT(t_o.pay_time,'%Y-%m-%d %H:%i:%s') ,'') AS payTime
	FROM
	  order_mall t_o 
	  LEFT JOIN user t_u
	  ON t_o.user_id = t_u.user_id
	WHERE t_o.del_flag = '0' 
	ORDER BY t_o.create_time DESC
  </select>
  
   <select id="selectLastUnfilledOrderByUserId" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from order_mall
    where user_id = #{userId,jdbcType=VARCHAR}
    	and order_status = '0'
    	and effective_time &gt;= NOW()
    	and del_flag = '0'
    order by create_time desc
    limit 0,1
  </select>
  
  <select id="selectLastCommodityOrderByUserId" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from order_mall
    where user_id = #{userId,jdbcType=VARCHAR}
    	and commodity_id = #{commodityId,jdbcType=VARCHAR}
    	and order_status in ('1','2')
    	<if test="dayRange != null">
    		and Datediff(NOW(),create_time) &lt;= #{dayRange,jdbcType=INTEGER}
    	</if>
    	and del_flag = '0'
    order by create_time desc
    limit 0,1
  </select>

  <select id="selectOrderList" parameterType="java.lang.String" resultType="java.util.Map">
    select
    o.order_id as orderId, o.commodity_id as commodityId, o.commodity_type as commodityType,
    o.user_id as userId, o.address_id as addressId, o.buy_type as buyType, money, coin,
    o.pay_type as payType, pay_time as payTime, o.create_time as createTime,DATE_FORMAT(o.create_time,'%Y-%m-%d %H:%i:%s') as creatTimeFormat, effective_time as effectiveTime,
    DATE_FORMAT(o.effective_time,'%Y-%m-%d %H:%i:%s')  as effectiveTimeFormat,order_status as orderStatus, order_type as orderType, o.del_flag as delFlag,
    t_c.commodity_name as commodityName,t_c.specification as specification,t_c.carousel_pic1 as carouselPic1,
    t_b.brand_name_chi as brandNameChi,t_b.logo_url as logoUrl
    from order_mall o
    left join commodity t_c
    on o.commodity_id=t_c.commodity_id
    LEFT JOIN commodity_brand t_b
    ON t_c.commodity_brand = t_b.brand_id
    where user_id = #{userId,jdbcType=VARCHAR}
    and o.del_flag = '0'
    and o.order_type='0'
    order by create_time desc
  </select>

  <select id="getOrderDetail" parameterType="java.lang.String" resultType="java.util.Map">
     select
    o.order_id as orderId, o.commodity_id as commodityId, o.commodity_type as commodityType,
    o.user_id as userId, o.address_id as addressId, o.buy_type as buyType, money, coin,
    o.pay_type as payType, pay_time as payTime, o.create_time as createTime,DATE_FORMAT(o.create_time,'%Y-%m-%d %H:%i:%s') as creatTimeFormat, effective_time as effectiveTime,
    DATE_FORMAT(o.effective_time,'%Y-%m-%d %H:%i:%s') as effectiveTimeFormat,order_status as orderStatus, order_type as orderType, o.del_flag as delFlag,
    t_c.commodity_name as commodityName,t_c.specification as specification,t_c.carousel_pic1 as carouselPic1,
    t_b.brand_name_chi as brandNameChi,t_b.logo_url as logoUrl,usa.receiver_name as receiverName,usa.receiver_phone as receiverPhone,
    usa.receiver_address as receiverAddress,usa.province as province,usa.city as city,usa.county as county
    from order_mall o
    left join commodity t_c
    on o.commodity_id=t_c.commodity_id
    LEFT JOIN commodity_brand t_b
    ON t_c.commodity_brand = t_b.brand_id
    left join user_shopping_address usa
    on o.address_id=usa.id
    where o.order_id = #{orderId,jdbcType=VARCHAR}
    and o.del_flag = '0'
    order by create_time desc

  </select>
</mapper>